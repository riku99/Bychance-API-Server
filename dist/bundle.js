(()=>{"use strict";var e={3157:(e,a,t)=>{Object.defineProperty(a,"__esModule",{value:!0}),a.checkBeareAccessToken=void 0;const r=t(212),o=t(2306),s=new r.PrismaClient;a.checkBeareAccessToken=async(e,a,t)=>{const r=e.query.id;if(!r)return{isValid:!1,credentials:{}};const i=await s.user.findUnique({where:{id:r}});return i&&i.accessToken===o.createHash(a)?{isValid:!0,credentials:{},artifacts:i}:{isValid:!1,credentials:{}}}},5854:(e,a)=>{Object.defineProperty(a,"__esModule",{value:!0}),a.invalidErrorType=a.loginErrorType=void 0,a.loginErrorType="loginError",a.invalidErrorType="invalidError"},6524:(e,a)=>{Object.defineProperty(a,"__esModule",{value:!0}),a.maxBytes=void 0,a.maxBytes=1e8},6459:(e,a)=>{Object.defineProperty(a,"__esModule",{value:!0}),a.dayMs=void 0,a.dayMs=864e5},8704:(e,a)=>{Object.defineProperty(a,"__esModule",{value:!0}),a.baseUrl=void 0,a.baseUrl="/api/v1"},173:(e,a,t)=>{Object.defineProperty(a,"__esModule",{value:!0}),a.deviceTokenHandler=void 0;const r=new(t(212).PrismaClient);a.deviceTokenHandler={createDeviceToken:async(e,a)=>{const t=e.auth.artifacts,o=e.payload;return await r.deviceToken.findUnique({where:{token:o.token}})||await r.deviceToken.create({data:{userId:t.id,token:o.token}}),a.response().code(200)}}},5947:(e,a,t)=>{Object.defineProperty(a,"__esModule",{value:!0}),a.flashStampsHandler=void 0;const r=new(t(212).PrismaClient);a.flashStampsHandler={createFlashStamp:async(e,a)=>{const t=e.auth.artifacts,o=e.payload;try{await r.flashStamp.create({data:{userId:t.id,flashId:o.flashId,value:o.value}})}catch{}return{userId:t.id,flashId:o.flashId,value:o.value}}}},3197:(e,a,t)=>{Object.defineProperty(a,"__esModule",{value:!0}),a.flashesHabdler=void 0;const r=t(212),o=t(1151),s=t(4158),i=t(6760),n=t(6465),l=new r.PrismaClient;a.flashesHabdler={createFlash:async(e,a)=>{const t=e.auth.artifacts,r=e.payload,d=await o.createS3ObjectPath({data:r.source,domain:"flash",id:t.id,ext:r.ext,sourceType:r.sourceType});if(!d)return i.throwInvalidError();const u=await l.flash.create({data:{source:d.source,sourceType:r.sourceType,userId:t.id},include:{viewed:!0,stamps:!0}}),c=n.createClientFlashStampValuesData([],u.id);return{flash:s.serializeFlash({flash:u}),stamps:c}},deleteFlash:async(e,a)=>{const t=e.auth.artifacts,r=e.params;return await l.flashStamp.deleteMany({where:{flashId:Number(r.flashId)}}),await l.viewedFlash.deleteMany({where:{flashId:Number(r.flashId)}}),(await l.flash.deleteMany({where:{id:Number(r.flashId),userId:t.id}})).count?a.response().code(200):i.throwInvalidError()}}},8166:function(e,a,t){var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(a,"__esModule",{value:!0}),a.nearbyUsersHandler=void 0;const o=t(212),s=r(t(8366)),i=t(4801),n=t(2306),l=t(1468),d=t(7618),u=t(6465),c=t(3147),p=new o.PrismaClient;a.nearbyUsersHandler={getNearbyUsers:async(e,a)=>{const t=e.auth.artifacts,r=e.query,o=i.point([r.lng,r.lat]),h=await p.viewedFlash.findMany({where:{userId:t.id}}),f=await p.user.findMany({where:{display:!0,login:!0,inPrivateZone:!1},include:{...d.postIncludes,...d.flashIncludes,privateTime:!0}}),m=[],v=new Date,g=v.getHours(),y=v.getMinutes(),w=f.filter((e=>{if(!e.lat||!e.lng)return!1;if(e.privateTime.find((e=>{const{startHours:a,startMinutes:t,endHours:r,endMinutes:o}=e;return c.confirmInTime({startHours:a,startMinutes:t,endHours:r,endMinutes:o,h:g,m:y})})))return!1;const{lat:a,lng:t}=n.handleUserLocationCrypt(e.lat,e.lng,"decrypt"),l=i.point([t,a]),d=s.default(o,l,{units:"kilometers"});return d<r.range&&m.push(d),d<r.range})).sort(((e,a)=>{const t=n.handleUserLocationCrypt(e.lat,e.lng,"decrypt"),r=n.handleUserLocationCrypt(a.lat,a.lng,"decrypt");return s.default(i.point([t.lng,t.lat]),o)<s.default(i.point([r.lng,r.lat]),o)?-1:1}));let _=[];return{usersData:w.map((e=>{const{posts:a,flashes:t,...r}=e,o=u.createClientFlashStamps(t);return _.push(...o),l.createAnotherUser({user:r,posts:a,flashes:t,viewedFlashes:h})})),flashStampsData:_}}}},833:(e,a,t)=>{Object.defineProperty(a,"__esModule",{value:!0}),a.nonceHandler=void 0;const r=t(4832);a.nonceHandler={create:async(e,a)=>{const{nonce:t}=e.payload;try{return await r.Nonce.create({nonce:t}),a.response().code(200)}catch(e){console.log(e)}}}},2700:(e,a,t)=>{Object.defineProperty(a,"__esModule",{value:!0}),a.postHandler=void 0;const r=t(212),o=t(5886),s=t(1151),i=t(6760),n=new r.PrismaClient;a.postHandler={createPost:async(e,a)=>{const t=e.auth.artifacts,r=e.payload,l=await s.createS3ObjectPath({data:r.source,domain:"post",id:t.id,ext:r.ext,sourceType:r.sourceType});if(!l)return i.throwInvalidError();const d=await n.post.create({data:{url:l.source,text:r.text,sourceType:r.sourceType,user:{connect:{id:t.id}}}});return o.serializePost({post:d})},deletePost:async(e,a)=>{const t=e.auth.artifacts,r=e.payload;return(await n.post.deleteMany({where:{id:r.postId,userId:t.id}})).count?a.response().code(200):i.throwInvalidError()}}},2669:(e,a,t)=>{Object.defineProperty(a,"__esModule",{value:!0}),a.privateTimeHandler=void 0;const r=t(212),o=t(6760),s=new r.PrismaClient;a.privateTimeHandler={createPrivateTime:async(e,a)=>{const t=e.auth.artifacts,{startHours:r,startMinutes:o,endHours:i,endMinutes:n}=e.payload,l=await s.privateTime.create({data:{startHours:r,startMinutes:o,endHours:i,endMinutes:n,userId:t.id}});return{id:l.id,startHours:l.startHours,startMinutes:l.startMinutes,endHours:l.endHours,endMinutes:l.endMinutes}},getPrivateTime:async(e,a)=>{const t=e.auth.artifacts;return await s.privateTime.findMany({where:{userId:t.id},select:{id:!0,startHours:!0,startMinutes:!0,endHours:!0,endMinutes:!0},orderBy:{createdAt:"desc"}})},deletePrivateTime:async(e,a)=>{const t=e.auth.artifacts,r=e.params;return(await s.privateTime.deleteMany({where:{id:Number(r.id),userId:t.id}})).count?a.response().code(200):o.throwInvalidError()}}},6082:function(e,a,t){var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(a,"__esModule",{value:!0}),a.privateZoneHandler=void 0;const o=t(212),s=r(t(8366)),i=t(4801),n=t(6760),l=t(2306),d=new o.PrismaClient;a.privateZoneHandler={getPrivateZone:async(e,a)=>{const t=e.auth.artifacts;return(await d.privateZone.findMany({where:{userId:t.id},select:{id:!0,address:!0},orderBy:{createdAt:"desc"}})).map((e=>{const a=l.handleAddressCrypt(e.address,"decrypt");return{id:e.id,address:a}}))},createPrivateZone:async(e,a)=>{const t=e.auth.artifacts,r=e.payload,o=l.handleUserLocationCrypt(r.lat,r.lng,"encrypt"),n=l.handleAddressCrypt(r.address,"encrypt"),u=await d.privateZone.create({data:{userId:t.id,lat:o.lat,lng:o.lng,address:n}});if(t.lat&&t.lng&&!t.inPrivateZone){const e=l.handleUserLocationCrypt(t.lat,t.lng,"decrypt"),a=i.point([r.lng,r.lat]),o=i.point([e.lng,e.lat]);s.default(a,o)<=Number(process.env.PRIVATE_ZONE_RANGE)&&await d.user.update({where:{id:t.id},data:{inPrivateZone:!0}})}return{id:u.id,address:r.address}},deletePrivateZone:async(e,a)=>{const t=e.auth.artifacts,r=e.params;if(!(await d.privateZone.deleteMany({where:{id:Number(r.id),userId:t.id}})).count)return n.throwInvalidError();if(t.lat&&t.lng&&t.inPrivateZone){const e=await d.privateZone.findMany({where:{userId:t.id}}),a=l.handleUserLocationCrypt(t.lat,t.lng,"decrypt"),r=i.point([a.lng,a.lat]);e.find((e=>{const a=l.handleUserLocationCrypt(e.lat,e.lng,"decrypt"),t=i.point([a.lng,a.lat]);return s.default(t,r)<=Number(process.env.PRIVATE_ZONE_RANGE)}))||await d.user.update({where:{id:t.id},data:{inPrivateZone:!1}})}return a.response().code(200)}}},1058:(e,a,t)=>{Object.defineProperty(a,"__esModule",{value:!0}),a.readTalkRoomMessageHandler=void 0;const r=new(t(212).PrismaClient);a.readTalkRoomMessageHandler={createReadTalkRoomMessage:async(e,a)=>{const t=e.auth.artifacts,o=e.payload,s=await r.talkRoomMessage.findMany({where:{roomId:o.talkRoomId,userId:o.partnerId},include:{readTalkRoomMessages:!0},skip:0,take:-o.unreadNumber}),i=[];return s.forEach((e=>{e.readTalkRoomMessages.length||i.push(r.readTalkRoomMessage.create({data:{userId:t.id,roomId:o.talkRoomId,messageId:e.id}}))})),await Promise.all(i),a.response().code(200)}}},3560:function(e,a,t){var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(a,"__esModule",{value:!0}),a.sessionsHandler=a.logout=a.sessionLogin=void 0;const o=r(t(2376)),s=t(212),i=t(2306),n=t(6760),l=t(1834),d=t(7618),u=new s.PrismaClient;a.sessionLogin=async(e,a)=>{const t=e.auth.artifacts;t.login||await u.user.update({where:{id:t.id},data:{login:!0}});const r=await u.user.findUnique({where:{id:t.id},include:d.createClientIncludes}),{posts:o,flashes:s,senderTalkRooms:i,recipientTalkRooms:n,talkRoomMessages:c,readTalkRoomMessages:p,viewedFlashes:h,...f}=r;return l.createClientData({user:f,posts:o,flashes:s,readTalkRoomMessages:p,viewedFlashes:h,senderTalkRooms:i,recipientTalkRooms:n})},a.logout=async(e,a)=>{const t=e.auth.artifacts;return await u.user.update({where:{id:t.id},data:{login:!1}}),a.response().code(200)},a.sessionsHandler={lineLogin:async(e,a)=>{const t=`id_token=${e.headers.authorization.split(" ")[1]}&client_id=${process.env.ChannelId}`;let r;try{r=await o.default.post("https://api.line.me/oauth2/v2.1/verify",t,{headers:{"Content-Type":"application/x-www-form-urlencoded"}})}catch(e){return console.log(e),void n.throwLoginError()}const s=r.data.nonce;if(!await u.nonce.findUnique({where:{nonce:s}}))return void n.throwLoginError();await u.nonce.delete({where:{nonce:s}});const c=r.data.sub,p=i.createHash(c),h=await u.user.findFirst({where:{lineId:p}}),f=i.createRandomString(),m=i.createHash(f),v=r.data.name,g=r.data.picture?r.data.picture:null,y=h?await u.user.update({where:{id:h.id},data:{accessToken:m},include:d.createClientIncludes}):await u.user.create({data:{lineId:p,accessToken:m,name:v,avatar:g},include:d.createClientIncludes});y.login||await u.user.update({where:{id:y.id},data:{login:!0}});const{posts:w,flashes:_,senderTalkRooms:b,recipientTalkRooms:M,talkRoomMessages:k,readTalkRoomMessages:R,viewedFlashes:P,...T}=y;return{...l.createClientData({user:T,posts:w,flashes:_,readTalkRoomMessages:R,viewedFlashes:P,senderTalkRooms:b,recipientTalkRooms:M}),accessToken:f}},sessionLogin:a.sessionLogin,logout:a.logout,sampleLogin:async(e,a)=>{const t=await u.user.findUnique({where:{id:"5b9a9b57-d497-4dd5-b257-cd5d10c2ea40"},include:d.createClientIncludes});await u.user.update({where:{id:"5b9a9b57-d497-4dd5-b257-cd5d10c2ea40"},data:{login:!0}});const{posts:r,flashes:o,senderTalkRooms:s,recipientTalkRooms:i,talkRoomMessages:n,readTalkRoomMessages:c,viewedFlashes:p,...h}=t;return{...l.createClientData({user:h,posts:r,flashes:o,readTalkRoomMessages:c,viewedFlashes:p,senderTalkRooms:s,recipientTalkRooms:i}),accessToken:"denzi"}}}},7310:(e,a,t)=>{Object.defineProperty(a,"__esModule",{value:!0}),a.talkRoomMessagesHandler=void 0;const r=t(212),o=t(8726),s=t(3966),i=t(6873),n=t(6760),l=t(1468),d=t(5802),u=new r.PrismaClient;a.talkRoomMessagesHandler={createTalkRoomMessage:async(e,a)=>{const t=e.auth.artifacts,r=e.payload,c=await u.user.findUnique({where:{id:r.partnerId},include:{readTalkRoomMessages:!0}});if(!c)return n.throwInvalidError("ユーザーが存在しません");if(!await u.talkRoom.findUnique({where:{id:r.talkRoomId}}))return{talkRoomPresence:!1,talkRoomId:r.talkRoomId};const p=await u.talkRoomMessage.create({data:{userId:t.id,roomId:r.talkRoomId,text:r.text,receipt:c.talkRoomMessageReceipt}}),h=o.serializeTalkRoomMessage({talkRoomMessage:p});if(!c.talkRoomMessageReceipt||!c.login)return{talkRoomPresence:!0,message:h,talkRoomId:r.talkRoomId};let f;if((await u.talkRoomMessage.findMany({where:{roomId:r.talkRoomId}})).find((e=>e.userId===r.partnerId&&e.receipt))){const e=await u.user.findUnique({where:{id:t.id}});if(!e)return n.throwInvalidError();f={isFirstMessage:!1,roomId:r.talkRoomId,message:h,sender:{id:e.id,avatar:e.avatar,name:e.name},show:c.showReceiveMessage}}else{const e=await u.user.findUnique({where:{id:t.id},include:{posts:!0,flashes:{include:{viewed:!0,stamps:!0}},viewedFlashes:!0}}),a=await u.talkRoom.findUnique({where:{id:r.talkRoomId},include:{messages:!0}});if(!a)return n.throwInvalidError();const{messages:o,...i}=a,d=await u.readTalkRoomMessage.findMany({where:{userId:r.partnerId}});if(!e)return n.throwInvalidError("ユーザーが存在しません");const{posts:p,flashes:m,viewedFlashes:v,...g}=e;f={isFirstMessage:!0,room:s.serializeTalkRoom({talkRoom:i,talkRoomMessages:o,readTalkRoomMessages:d,userId:r.partnerId}),message:h,sender:l.createAnotherUser({user:g,posts:p,flashes:m,viewedFlashes:v}),show:c.showReceiveMessage}}i.talkRoomMessageNameSpace.to(r.partnerId).emit("recieveTalkRoomMessage",f);const m=(await u.deviceToken.findMany({where:{userId:r.partnerId}})).map((e=>e.token));return d.pushNotificationToMany({tokens:m,notification:{title:"メッセージが届きました"},data:{type:"talkRoomMessages",talkRoomId:String(r.talkRoomId),partnerId:t.id},apns:{payload:{aps:{sound:"default",contentAvailable:!0}}}}),{talkRoomPresence:!0,message:h,talkRoomId:r.talkRoomId}}}},5036:(e,a,t)=>{Object.defineProperty(a,"__esModule",{value:!0}),a.talkRoomsHandler=void 0;const r=new(t(212).PrismaClient);a.talkRoomsHandler={createTalkRoom:async(e,a)=>{const t=e.auth.artifacts,o=e.payload,s=await r.talkRoom.findMany({where:{OR:[{senderId:t.id,recipientId:o.partnerId},{senderId:o.partnerId,recipientId:t.id}]}}),i=s.length?s[0]:null;if(i&&!await r.deleteTalkRoom.findUnique({where:{userId_talkRoomId:{userId:t.id,talkRoomId:i.id}}}))return{presence:!0,roomId:i.id,timestamp:i.updatedAt.toString()};const n=await r.talkRoom.create({data:{senderId:t.id,recipientId:o.partnerId}});return{presence:!1,roomId:n.id,timestamp:n.createdAt.toString()}},deleteTalkRoom:async(e,a)=>{const t=e.params;await r.readTalkRoomMessage.deleteMany({where:{roomId:t.talkRoomId}}),await r.talkRoomMessage.deleteMany({where:{roomId:t.talkRoomId}});try{await r.talkRoom.delete({where:{id:t.talkRoomId}})}catch{}return a.response().code(200)}}},302:function(e,a,t){var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(a,"__esModule",{value:!0}),a.usersHandler=void 0;const o=t(212),s=r(t(8366)),i=t(4801),n=t(8750),l=t(1151),d=t(6760),u=t(2306),c=t(1468),p=t(7618),h=t(6465),f=t(280),m=new o.PrismaClient;a.usersHandler={updateUser:async(e,a)=>{const t=e.auth.artifacts,{deleteAvatar:r,deleteBackGroundItem:o,avatarExt:s,backGroundItemExt:i,...d}=e.payload;let u,c,p;if(d.avatar&&s&&!r){const e=await l.createS3ObjectPath({data:d.avatar,domain:"avatar",id:t.id,ext:s});u=e?e.source:t.avatar}else u=r?null:t.avatar;if(d.backGroundItem&&i&&!o){const e=await l.createS3ObjectPath({data:d.backGroundItem,domain:"backGroundItem",id:t.id,sourceType:d.backGroundItemType,ext:i});if(!e)throw new Error;c=e.source,p=d.backGroundItemType?d.backGroundItemType:null}else o?(c=null,p=null):(c=t.backGroundItem,p=t.backGroundItemType);const h=await m.user.update({where:{id:t.id},data:{...t,...d,avatar:u,backGroundItem:c,backGroundItemType:p}});return n.serializeUser({user:h})},refreshUser:async(e,a)=>{const t=e.auth.artifacts,r=e.payload,o=t.id===r.userId,s=await m.user.findUnique({where:{id:r.userId},include:{...p.postIncludes,...p.flashIncludes}});if(!s)return d.throwInvalidError("ユーザーが存在しません");if(o){const{posts:e,flashes:a,...t}=s;return{isMyData:o,user:n.serializeUser({user:t}),posts:f.createClientPosts(e),flashes:h.createClientFlashes(a),flashStamps:h.createClientFlashStamps(a)}}{const e=await m.viewedFlash.findMany({where:{userId:t.id}}),{posts:a,flashes:r,...i}=s,n=h.createClientFlashStamps(r);return{isMyData:o,data:{user:c.createAnotherUser({user:i,posts:a,flashes:r,viewedFlashes:e}),flashStamps:n}}}},updateLocation:async(e,a)=>{const t=e.auth.artifacts,r=e.payload,o=u.handleUserLocationCrypt(r.lat,r.lng,"encrypt"),n=await m.privateZone.findMany({where:{userId:t.id}}),l=i.point([r.lng,r.lat]),d=n.find((e=>{const a=u.handleUserLocationCrypt(e.lat,e.lng,"decrypt"),t=i.point([a.lng,a.lat]);return s.default(t,l)<=Number(process.env.PRIVATE_ZONE_RANGE)}));return await m.user.update({where:{id:t.id},data:{...o,inPrivateZone:!!d}}),a.response().code(200)},changeDisplay:async(e,a)=>{const t=e.auth.artifacts,r=e.payload;return await m.user.update({where:{id:t.id},data:{display:r.display}}),a.response().code(200)},changeVideoEditDescription:async(e,a)=>{const t=e.auth.artifacts,r=e.payload;try{await m.user.update({where:{id:t.id},data:{videoEditDescription:r.videoEditDescription}})}catch{}return a.response().code(200)},changeTalkRoomMessageReceipt:async(e,a)=>{const t=e.auth.artifacts,r=e.payload;try{await m.user.update({where:{id:t.id},data:{talkRoomMessageReceipt:r.receipt}})}catch{}return a.response().code(200)},changeShowReceiveMessage:async(e,a)=>{const t=e.auth.artifacts,r=e.payload;try{await m.user.update({where:{id:t.id},data:{showReceiveMessage:r.showReceiveMessage}})}catch{return d.throwInvalidError("変更に失敗しました")}return a.response().code(200)},deleteLocation:async(e,a)=>{const t=e.auth.artifacts;try{await m.user.update({where:{id:t.id},data:{lat:null,lng:null,inPrivateZone:!1}})}catch{return d.throwInvalidError("削除に失敗しました")}return a.response().code(200)}}},6977:(e,a,t)=>{Object.defineProperty(a,"__esModule",{value:!0}),a.viewedFlashHandler=void 0;const r=new(t(212).PrismaClient);a.viewedFlashHandler={createViewedFlash:async(e,a)=>{const t=e.auth.artifacts,o=e.payload;if(await r.viewedFlash.findUnique({where:{userId_flashId_unique:{userId:t.id,flashId:o.flashId}}}))return a.response().code(200);try{await r.viewedFlash.create({data:{flashId:o.flashId,userId:t.id}})}catch{}return a.response().code(200)}}},1468:(e,a,t)=>{Object.defineProperty(a,"__esModule",{value:!0}),a.createAnotherUser=void 0;const r=t(5886),o=t(4158),s=t(6465),i=t(2306);a.createAnotherUser=({user:e,posts:a,flashes:t,viewedFlashes:n})=>{const{id:l,name:d,avatar:u,introduce:c,statusMessage:p,backGroundItem:h,backGroundItemType:f,instagram:m,twitter:v,youtube:g,tiktok:y,lat:w,lng:_}=e,b=a.map((e=>r.serializePost({post:e}))),M=n.map((e=>e.flashId)),k=[],R=t.filter((e=>{const a=s.filterExpiredFlash(e.createdAt);return a&&M.includes(e.id)&&k.push(e.id),a})),P=R.length&&R[R.length-1].id,T=k.includes(P),I={entities:R.map((e=>o.serializeFlash({flash:e}))),alreadyViewed:k,isAllAlreadyViewed:T};let A=null,E=null;if(w&&_){const{lat:e,lng:a}=i.handleUserLocationCrypt(w,_,"decrypt");A=e,E=a}return{id:l,name:d,avatar:u,introduce:c,statusMessage:p,backGroundItem:h,instagram:m,twitter:v,youtube:g,tiktok:y,backGroundItemType:f,posts:b,flashes:I,lat:A,lng:E}}},1151:function(e,a,t){var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(a,"__esModule",{value:!0}),a.createS3ObjectPath=void 0;const o=r(t(3480)),s=r(t(742)),i=r(t(5747)),n=r(t(5114)),l=r(t(1669)),d=t(2306),u=l.default.promisify(i.default.writeFile),c=l.default.promisify(i.default.unlink),p=l.default.promisify(i.default.readFile),h=new o.default.S3({accessKeyId:process.env.AWS_KEY,secretAccessKey:process.env.AWS_SECRET_KEY,region:process.env.AWS_REGION}),f=async e=>await h.upload(e).promise().then((e=>e.Location)).catch((e=>{throw console.log(e),new Error})),m=(e,a)=>{const t=a.width.toString(),r=a.height.toString(),o=`./tmp/video/"${d.createRandomString().replace(/\//g,"")}.mp4`;return new Promise((async a=>{try{n.default(e).size(`${t}x${r}`).videoCodec("libx264").toFormat("mp4").save(o).on("end",(async()=>{const e=await p(o);a(e),await c(o)}))}catch{await c(o)}}))},v=e=>{const a=d.createRandomString().replace(/\//g,""),t=`./tmp/thumbnails/${a}.png`;return new Promise((async r=>{try{n.default(e).screenshots({count:1,timestamps:[0],size:"720x1280",folder:"./tmp/thumbnails",filename:`${a}.png`}).on("end",(async()=>{const e=await p(t),a=await s.default(e).webp().toBuffer();r(a),await c(t)}))}catch{await c(t)}}))};a.createS3ObjectPath=async({data:e,domain:a,id:t,sourceType:r="image",ext:o})=>{let i,n;switch(r){case"image":i="image/webp",n="webp";break;case"video":i="video/mp4",n="mp4"}const{width:l,height:p}=(e=>{switch(e){case"post":return{width:768,height:1024};case"flash":return{width:720,height:1280};case"avatar":return{width:500,height:500};case"backGroundItem":return{width:768,height:1024};default:return{width:500,height:500}}})(a),h=d.createRandomString().replace(/\//g,"w"),g=`${t}/${a}/${h}.${n}`,y=e.replace(/^data:\w+\/\w+;base64,/,""),w=Buffer.from(y,"base64"),_={Bucket:process.env.BUCKET_NAME,Key:g,ContentType:i};let b,M;if(console.log(l+":"+p),"image"===r)b=await s.default(w).rotate().resize(l,p).webp().toBuffer();else{const e=`./tmp/video/"${d.createRandomString().replace(/\//g,"")}.${o}`;try{await u(e,w);const a=await Promise.all([m(e,{width:l,height:p}),v(e)]);b=a[0],M=a[1],await c(e)}catch{await c(e)}}const k={..._,Body:b};let R,P;if(M&&(R={Bucket:process.env.BUCKET_NAME,Key:`${t}/${a}/${h}_thumbnail.webp`,ContentType:"image/webp",Body:M}),R){const e=await Promise.all([f(k),f(R)]);P={source:e[0],thumbnail:e[1]}}else P={source:await f(k)};return P}},1834:(e,a,t)=>{Object.defineProperty(a,"__esModule",{value:!0}),a.createClientData=void 0;const r=t(8750),o=t(3966),s=t(8726),i=t(1468),n=t(6465),l=t(280);a.createClientData=e=>{const a=r.serializeUser({user:e.user}),t=l.createClientPosts(e.posts),d=n.createClientFlashes(e.flashes);let u=[];const c=n.createClientFlashStamps(e.flashes);u.push(...c);let p=[],h=[];[...e.senderTalkRooms,...e.recipientTalkRooms].forEach((t=>{let r=!1;if(t.senderId===a.id&&(r=!0),t.messages.forEach((t=>{if(!r&&t.userId!==a.id&&t.receipt&&(r=!0),t.receipt||t.userId===e.user.id){const e=s.serializeTalkRoomMessage({talkRoomMessage:t});h.push(e)}})),r){const a=e.readTalkRoomMessages.filter((e=>e.roomId===t.id)),r=o.serializeTalkRoom({talkRoom:t,talkRoomMessages:t.messages,readTalkRoomMessages:a,userId:e.user.id});p.push(r)}}));const f=[...e.senderTalkRooms.map((e=>e.recipient)),...e.recipientTalkRooms.map((e=>e.sender))].map((a=>{const{posts:t,flashes:r,...o}=a,s=n.createClientFlashStamps(r);return u.push(...s),i.createAnotherUser({user:o,posts:t,flashes:r,viewedFlashes:e.viewedFlashes})}));return{user:a,posts:t,flashes:d,rooms:p,messages:h,chatPartners:f,flashStamps:u}}},2306:function(e,a,t){var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(a,"__esModule",{value:!0}),a.handleAddressCrypt=a.handleUserLocationCrypt=a.createRandomString=a.createHash=void 0;const o=r(t(419)),s=r(t(6902)),i=t(1231);a.createHash=e=>s.default(process.env.hashNonce+e).toString(o.default.enc.Base64),a.createRandomString=()=>{const e=(new Date).getTime().toString(),a=Math.floor(1e4*Math.random()),t=i.v4();return s.default(e+a+t).toString(o.default.enc.Base64)},a.handleUserLocationCrypt=(e,a,t)=>{if("number"==typeof e&&"number"==typeof a&&"encrypt"===t)return{lat:o.default.AES.encrypt(String(e),process.env.USER_LOCATION_KEY||"testkey").toString(),lng:o.default.AES.encrypt(String(a),process.env.USER_LOCATION_KEY||"testkey").toString()};if("string"==typeof e&&"string"==typeof a&&"decrypt"===t){const t=o.default.AES.decrypt(e,process.env.USER_LOCATION_KEY||"testkey").toString(o.default.enc.Utf8),r=o.default.AES.decrypt(a,process.env.USER_LOCATION_KEY||"testkey").toString(o.default.enc.Utf8);return{lat:Number(t),lng:Number(r)}}},a.handleAddressCrypt=(e,a)=>"encrypt"===a?o.default.AES.encrypt(e,process.env.USER_LOCATION_KEY||"testkey").toString():o.default.AES.decrypt(e,process.env.USER_LOCATION_KEY||"testkey").toString(o.default.enc.Utf8)},6760:function(e,a,t){var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(a,"__esModule",{value:!0}),a.throwInvalidError=a.throwLoginError=void 0;const o=r(t(7796)),s=t(5854);a.throwLoginError=()=>{const e=o.default.unauthorized();throw e.output.payload.errorType=s.loginErrorType,e},a.throwInvalidError=(e="無効なリクエストです")=>{const a=o.default.badRequest();throw a.output.payload.message=e,a.output.payload.errorType=s.invalidErrorType,a}},6465:(e,a,t)=>{Object.defineProperty(a,"__esModule",{value:!0}),a.createClientFlashStamps=a.createClientFlashStampValuesData=a.createClientFlashes=a.filterExpiredFlash=void 0;const r=t(3147),o=t(4158);a.filterExpiredFlash=e=>r.filterByDayDiff(e,20),a.createClientFlashes=e=>e.filter((e=>a.filterExpiredFlash(e.createdAt))).map((e=>o.serializeFlash({flash:e}))),a.createClientFlashStampValuesData=(e,a)=>{let t={thumbsUp:{number:0,userIds:[]},yusyo:{number:0,userIds:[]},yoi:{number:0,userIds:[]},itibann:{number:0,userIds:[]},seikai:{number:0,userIds:[]}};return e.forEach((e=>{t[e.value].number+=1,t[e.value].userIds.push(e.userId)})),{flashId:a,data:t}},a.createClientFlashStamps=e=>e.map((e=>{if(a.filterExpiredFlash(e.createdAt))return a.createClientFlashStampValuesData(e.stamps,e.id)})).filter((e=>void 0!==e))},280:(e,a,t)=>{Object.defineProperty(a,"__esModule",{value:!0}),a.createClientPosts=void 0;const r=t(5886);a.createClientPosts=e=>e.map((e=>r.serializePost({post:e})))},5802:function(e,a,t){var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(a,"__esModule",{value:!0}),a.pushNotificationToMany=a.pushNotificationToOne=void 0;const o=r(t(4054));a.pushNotificationToOne=async e=>{await o.default.messaging().send(e)},a.pushNotificationToMany=async e=>{await o.default.messaging().sendMulticast(e)}},4832:(e,a,t)=>{Object.defineProperty(a,"__esModule",{value:!0}),a.Nonce=void 0;const r=new(t(212).PrismaClient);a.Nonce={create:async({nonce:e})=>await r.nonce.create({data:{nonce:e}}),findFirst:async({nonce:e})=>await r.nonce.findFirst({where:{nonce:e}})}},8331:(e,a,t)=>{Object.defineProperty(a,"__esModule",{value:!0}),a.deviceTokenPlugin=void 0;const r=t(3220);a.deviceTokenPlugin={name:"app/routes/deviceToken",register:r.deviceTokenRoute}},7760:(e,a,t)=>{Object.defineProperty(a,"__esModule",{value:!0}),a.flashStampsPlugin=void 0;const r=t(2030);a.flashStampsPlugin={name:"app/routes/flashStamps",register:r.flashStampsRoute}},3643:(e,a,t)=>{Object.defineProperty(a,"__esModule",{value:!0}),a.flashesPlugin=void 0;const r=t(9634);a.flashesPlugin={name:"app/routes/flashes",register:r.flashesRoute}},262:(e,a,t)=>{Object.defineProperty(a,"__esModule",{value:!0}),a.nearbyUsersPlugin=void 0;const r=t(9288);a.nearbyUsersPlugin={name:"app/routes/nearbyUsers",register:r.nearbyUsersRoute}},8263:(e,a,t)=>{Object.defineProperty(a,"__esModule",{value:!0}),a.noncePlugin=void 0;const r=t(4371);a.noncePlugin={name:"app/routes/nonce",register:r.nonce}},1550:(e,a,t)=>{Object.defineProperty(a,"__esModule",{value:!0}),a.postsPlugin=void 0;const r=t(5043);a.postsPlugin={name:"app/routes/posts",register:r.postsRoute}},9711:(e,a,t)=>{Object.defineProperty(a,"__esModule",{value:!0}),a.prismaPlugin=void 0;const r=t(212);a.prismaPlugin={name:"prisma",register:async e=>{const a=new r.PrismaClient;e.app.prisma=a,e.ext({type:"onPostStop",method:async e=>{e.app.prisma.$disconnect()}})}}},1916:(e,a,t)=>{Object.defineProperty(a,"__esModule",{value:!0}),a.privateTimePlugin=void 0;const r=t(593);a.privateTimePlugin={name:"app/routes/privateTime",register:r.privateTimeRoute}},9078:(e,a,t)=>{Object.defineProperty(a,"__esModule",{value:!0}),a.privateZonePlugin=void 0;const r=t(2330);a.privateZonePlugin={name:"app/route/privateZone",register:r.privateZoneRoute}},6509:(e,a,t)=>{Object.defineProperty(a,"__esModule",{value:!0}),a.readTalkRoomMessagesPlugin=void 0;const r=t(9552);a.readTalkRoomMessagesPlugin={name:"app/routes/readTalkRoomMessages",register:r.readTalkRoomMessagesRoute}},2182:(e,a,t)=>{Object.defineProperty(a,"__esModule",{value:!0}),a.rootPlugin=void 0;const r=t(9474);a.rootPlugin={name:"app/routes/root",register:r.root}},5601:(e,a,t)=>{Object.defineProperty(a,"__esModule",{value:!0}),a.sesisonsPlugin=void 0;const r=t(889);a.sesisonsPlugin={name:"app/routes/sessions",register:r.sessionsRoute}},7335:(e,a,t)=>{Object.defineProperty(a,"__esModule",{value:!0}),a.talkRoomMessagesPlugin=void 0;const r=t(7125);a.talkRoomMessagesPlugin={name:"app/routes/talkRoomMessages",register:r.talkRoomMessagesRoute}},7134:(e,a,t)=>{Object.defineProperty(a,"__esModule",{value:!0}),a.talkRoomsPlugin=void 0;const r=t(3168);a.talkRoomsPlugin={name:"app/routes/talkRooms",register:r.talkRoomsRoute}},4452:(e,a,t)=>{Object.defineProperty(a,"__esModule",{value:!0}),a.usersPlugin=void 0;const r=t(9038);a.usersPlugin={name:"app/routes/users",register:r.usersRoute}},328:(e,a,t)=>{Object.defineProperty(a,"__esModule",{value:!0}),a.viewedFlashesPlugin=void 0;const r=t(161);a.viewedFlashesPlugin={name:"app/routes/viewedFlashes",register:r.viewedFlashesRoute}},7618:(e,a)=>{Object.defineProperty(a,"__esModule",{value:!0}),a.createClientIncludes=a.flashIncludes=a.postIncludes=void 0,a.postIncludes={posts:{orderBy:{createdAt:"desc"}}},a.flashIncludes={flashes:{include:{viewed:!0,stamps:!0}}},a.createClientIncludes={...a.postIncludes,...a.flashIncludes,talkRoomMessages:!0,readTalkRoomMessages:!0,viewedFlashes:!0,senderTalkRooms:{include:{messages:!0,recipient:{include:{...a.postIncludes,...a.flashIncludes}}}},recipientTalkRooms:{include:{messages:!0,sender:{include:{...a.postIncludes,...a.flashIncludes}}}}}},3220:(e,a,t)=>{Object.defineProperty(a,"__esModule",{value:!0}),a.deviceTokenRoute=void 0;const r=t(8704),o=t(4086),s=t(173);a.deviceTokenRoute=e=>{e.route([{method:"POST",path:`${r.baseUrl}/deviceToken`,handler:s.deviceTokenHandler.createDeviceToken,options:{validate:{payload:o.createDeviceTokenValidator.validate.payload,failAction:o.createDeviceTokenValidator.failAction}}}])}},4086:function(e,a,t){var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(a,"__esModule",{value:!0}),a.createDeviceTokenValidator=void 0;const o=r(t(4320)),s=t(6760),i={payload:o.default.object({token:o.default.string().required()})};a.createDeviceTokenValidator={validate:i,failAction:()=>s.throwInvalidError()}},2030:(e,a,t)=>{Object.defineProperty(a,"__esModule",{value:!0}),a.flashStampsRoute=void 0;const r=t(8704),o=t(6775),s=t(5947),i=`${r.baseUrl}/flashStamps`;a.flashStampsRoute=async e=>{e.route([{method:"POST",path:i,handler:s.flashStampsHandler.createFlashStamp,options:{validate:{payload:o.createFlashStampValidator.validate.payload,failAction:o.createFlashStampValidator.failAction}}}])}},6775:function(e,a,t){var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(a,"__esModule",{value:!0}),a.createFlashStampValidator=void 0;const o=r(t(4320)),s=t(6760),i={payload:o.default.object({flashId:o.default.number().required(),value:o.default.string().valid("thumbsUp","yusyo","yoi","itibann","seikai").required()})};a.createFlashStampValidator={validate:i,failAction:()=>s.throwInvalidError()}},9634:(e,a,t)=>{Object.defineProperty(a,"__esModule",{value:!0}),a.flashesRoute=void 0;const r=t(8704),o=t(9573),s=t(3197),i=t(6524);a.flashesRoute=async e=>{e.route([{method:"POST",path:`${r.baseUrl}/flashes`,handler:s.flashesHabdler.createFlash,options:{validate:{payload:o.createFlashValidator.validate.payload,failAction:o.createFlashValidator.failAction},payload:{maxBytes:i.maxBytes}}},{method:"DELETE",path:`${r.baseUrl}/flashes/{flashId}`,handler:s.flashesHabdler.deleteFlash,options:{validate:{params:o.deleteFlashValidator.validate.params,failAction:o.deleteFlashValidator.failAction}}}])}},9573:function(e,a,t){var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(a,"__esModule",{value:!0}),a.deleteFlashValidator=a.createFlashValidator=void 0;const o=r(t(4320)),s=t(6760),i={payload:o.default.object({source:o.default.string().required(),sourceType:o.default.string().valid("image","video").required(),ext:o.default.string().required()})};a.createFlashValidator={validate:i,failAction:()=>s.throwInvalidError()};const n={params:o.default.object({flashId:o.default.string().required()})};a.deleteFlashValidator={validate:n,failAction:()=>s.throwInvalidError()}},9288:(e,a,t)=>{Object.defineProperty(a,"__esModule",{value:!0}),a.nearbyUsersRoute=void 0;const r=t(8704),o=t(6391),s=t(8166);a.nearbyUsersRoute=async e=>{e.route([{method:"GET",path:`${r.baseUrl}/nearbyUsers`,handler:s.nearbyUsersHandler.getNearbyUsers,options:{validate:{query:o.getNearbyUsersValidator.validate.query,failAction:o.getNearbyUsersValidator.failAction}}}])}},6391:function(e,a,t){var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(a,"__esModule",{value:!0}),a.getNearbyUsersValidator=void 0;const o=r(t(4320)),s=t(6760),i={query:o.default.object({lat:o.default.number().required(),lng:o.default.number().required(),range:o.default.number().required(),id:o.default.string().required()})};a.getNearbyUsersValidator={validate:i,failAction:()=>s.throwInvalidError()}},4371:(e,a,t)=>{Object.defineProperty(a,"__esModule",{value:!0}),a.nonce=void 0;const r=t(833),o=t(4176),s=t(8704);a.nonce=async e=>{e.route([{method:"POST",path:`${s.baseUrl}/nonce`,handler:r.nonceHandler.create,options:{validate:{payload:o.createNonceValidator.validate,failAction:o.createNonceValidator.failAction},auth:!1}}])}},4176:function(e,a,t){var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(a,"__esModule",{value:!0}),a.createNonceValidator=void 0;const o=r(t(4320)),s=t(6760),i=o.default.object({nonce:o.default.string().required()});a.createNonceValidator={validate:i,failAction:()=>s.throwLoginError()}},5043:(e,a,t)=>{Object.defineProperty(a,"__esModule",{value:!0}),a.postsRoute=void 0;const r=t(8704),o=t(8039),s=t(2700),i=t(6524);a.postsRoute=async e=>{e.route([{method:"POST",path:`${r.baseUrl}/posts`,handler:s.postHandler.createPost,options:{validate:{payload:o.createPostValidator.validate.payload,failAction:o.createPostValidator.failAction},payload:{maxBytes:i.maxBytes,timeout:2e4}}},{method:"DELETE",path:`${r.baseUrl}/posts`,handler:s.postHandler.deletePost,options:{validate:{payload:o.deletePostValidator.validate.payload,failAction:o.deletePostValidator.failAction}}}])}},8039:function(e,a,t){var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(a,"__esModule",{value:!0}),a.deletePostValidator=a.createPostValidator=void 0;const o=r(t(4320)),s=t(6760),i={payload:o.default.object({text:o.default.string().allow("").max(150).required(),source:o.default.string().required(),sourceType:o.default.string().valid("image","video").required(),ext:o.default.string().required()})};a.createPostValidator={validate:i,failAction:()=>s.throwInvalidError()};const n={payload:o.default.object({postId:o.default.number().required()})};a.deletePostValidator={validate:n,failAction:()=>s.throwInvalidError()}},593:(e,a,t)=>{Object.defineProperty(a,"__esModule",{value:!0}),a.privateTimeRoute=void 0;const r=t(8704),o=t(858),s=t(2669),i=`${r.baseUrl}/privateTime`;a.privateTimeRoute=async e=>{e.route([{method:"POST",path:i,handler:s.privateTimeHandler.createPrivateTime,options:{validate:{payload:o.privateTimeValidator.create.validator.payload,failAction:o.privateTimeValidator.create.failAction}}},{method:"GET",path:i,handler:s.privateTimeHandler.getPrivateTime},{method:"DELETE",path:`${i}/{id}`,handler:s.privateTimeHandler.deletePrivateTime,options:{validate:{params:o.privateTimeValidator.delete.validator.params,failAction:o.privateTimeValidator.delete.failAction}}}])}},858:function(e,a,t){var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(a,"__esModule",{value:!0}),a.privateTimeValidator=void 0;const o=r(t(4320)),s=t(6760),i={payload:o.default.object({startHours:o.default.number().required(),startMinutes:o.default.number().required(),endHours:o.default.number().required(),endMinutes:o.default.number().required()})},n={params:o.default.object({id:o.default.string().required()})};a.privateTimeValidator={create:{validator:i,failAction:()=>s.throwInvalidError()},delete:{validator:n,failAction:()=>s.throwInvalidError()}}},2330:(e,a,t)=>{Object.defineProperty(a,"__esModule",{value:!0}),a.privateZoneRoute=void 0;const r=t(8704),o=t(6082),s=t(3535),i=`${r.baseUrl}/privateZone`;a.privateZoneRoute=async e=>{e.route([{method:"GET",path:i,handler:o.privateZoneHandler.getPrivateZone},{method:"POST",path:i,handler:o.privateZoneHandler.createPrivateZone,options:{validate:{payload:s.privateZoneValidator.create.validator.payload,failAction:s.privateZoneValidator.create.failAction}}},{method:"DELETE",path:`${i}/{id}`,handler:o.privateZoneHandler.deletePrivateZone,options:{validate:{params:s.privateZoneValidator.delete.validator.params,failAction:s.privateZoneValidator.delete.failAction}}}])}},3535:function(e,a,t){var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(a,"__esModule",{value:!0}),a.privateZoneValidator=void 0;const o=r(t(4320)),s=t(6760),i={payload:o.default.object({address:o.default.string().required(),lat:o.default.number().required(),lng:o.default.number().required()})},n={params:o.default.object({id:o.default.string().required()})};a.privateZoneValidator={create:{validator:i,failAction:()=>s.throwInvalidError()},delete:{validator:n,failAction:()=>s.throwInvalidError()}}},9552:(e,a,t)=>{Object.defineProperty(a,"__esModule",{value:!0}),a.readTalkRoomMessagesRoute=void 0;const r=t(8704),o=t(4438),s=t(1058);a.readTalkRoomMessagesRoute=async e=>{e.route([{method:"POST",path:`${r.baseUrl}/readTalkRoomMessages`,handler:s.readTalkRoomMessageHandler.createReadTalkRoomMessage,options:{validate:{payload:o.createReadTalkRoomMessagesValidator.validate.payload,failAction:o.createReadTalkRoomMessagesValidator.failAction}}}])}},4438:function(e,a,t){var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(a,"__esModule",{value:!0}),a.createReadTalkRoomMessagesValidator=void 0;const o=r(t(4320)),s=t(6760),i={payload:o.default.object({talkRoomId:o.default.number().required(),partnerId:o.default.string().required(),unreadNumber:o.default.number().required()})};a.createReadTalkRoomMessagesValidator={validate:i,failAction:()=>s.throwInvalidError()}},9474:(e,a)=>{Object.defineProperty(a,"__esModule",{value:!0}),a.root=void 0,a.root=async e=>{e.route({method:"GET",path:"/",handler:(e,a)=>"Hello World",options:{auth:!1}})}},889:(e,a,t)=>{Object.defineProperty(a,"__esModule",{value:!0}),a.sessionsRoute=a.logoutPath=a.sessionLoginPath=a.lineLoginPath=void 0;const r=t(2007),o=t(3560),s=t(8704);a.lineLoginPath=`${s.baseUrl}/sessions/lineLogin`,a.sessionLoginPath=`${s.baseUrl}/sessions/sessionlogin`,a.logoutPath=`${s.baseUrl}/sessions/logout`,a.sessionsRoute=async e=>{e.route([{method:"POST",path:a.lineLoginPath,handler:o.sessionsHandler.lineLogin,options:{validate:{headers:r.sessionsValidator.lineLogin.validate.headers,options:{allowUnknown:!0},failAction:r.sessionsValidator.lineLogin.failAction},auth:!1}},{method:"GET",path:a.sessionLoginPath,handler:o.sessionsHandler.sessionLogin},{method:"GET",path:a.logoutPath,handler:o.sessionsHandler.logout},{method:"GET",path:`${s.baseUrl}/sampleLogin`,handler:o.sessionsHandler.sampleLogin,options:{auth:!1}}])}},2007:function(e,a,t){var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(a,"__esModule",{value:!0}),a.sessionsValidator=a.lineLoginValidator=void 0;const o=r(t(4320)),s=t(6760);a.lineLoginValidator={headers:o.default.object({authorization:o.default.string().required()})},a.sessionsValidator={lineLogin:{validate:a.lineLoginValidator,failAction:(e,a,t)=>s.throwLoginError()}}},7125:(e,a,t)=>{Object.defineProperty(a,"__esModule",{value:!0}),a.talkRoomMessagesRoute=void 0;const r=t(8704),o=t(9577),s=t(7310);a.talkRoomMessagesRoute=async e=>{e.route([{method:"POST",path:`${r.baseUrl}/talkRoomMessages`,handler:s.talkRoomMessagesHandler.createTalkRoomMessage,options:{validate:{payload:o.createTalkRoomMessageValidator.validate.payload,failAction:o.createTalkRoomMessageValidator.failAction}}}])}},9577:function(e,a,t){var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(a,"__esModule",{value:!0}),a.createTalkRoomMessageValidator=void 0;const o=r(t(4320)),s=t(6760),i={payload:o.default.object({talkRoomId:o.default.number().required(),text:o.default.string().required(),partnerId:o.default.string().required()})};a.createTalkRoomMessageValidator={validate:i,failAction:()=>s.throwInvalidError()}},3168:(e,a,t)=>{Object.defineProperty(a,"__esModule",{value:!0}),a.talkRoomsRoute=void 0;const r=t(8704),o=t(5799),s=t(5036);a.talkRoomsRoute=async e=>{e.route([{method:"POST",path:`${r.baseUrl}/talkRooms`,handler:s.talkRoomsHandler.createTalkRoom,options:{validate:{payload:o.createTalkRoomValidator.validate.payload,failAction:o.createTalkRoomValidator.failAction}}},{method:"DELETE",path:`${r.baseUrl}/talkRooms/{talkRoomId}`,handler:s.talkRoomsHandler.deleteTalkRoom,options:{validate:{params:o.deleteTalkRoomValidator.validate.params,failAction:o.deleteTalkRoomValidator.failAction}}}])}},5799:function(e,a,t){var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(a,"__esModule",{value:!0}),a.deleteTalkRoomValidator=a.createTalkRoomValidator=void 0;const o=r(t(4320)),s=t(6760),i={payload:o.default.object({partnerId:o.default.string().required()})};a.createTalkRoomValidator={validate:i,failAction:()=>s.throwInvalidError()};const n={params:o.default.object({talkRoomId:o.default.number().required()})};a.deleteTalkRoomValidator={validate:n,failAction:()=>s.throwInvalidError()}},9038:(e,a,t)=>{Object.defineProperty(a,"__esModule",{value:!0}),a.usersRoute=void 0;const r=t(3845),o=t(302),s=t(8704),i=t(6524),n=`${s.baseUrl}/users/showReceiveMessage`,l=`${s.baseUrl}/users/location`;a.usersRoute=async e=>{e.route([{method:"PATCH",path:`${s.baseUrl}/users`,handler:o.usersHandler.updateUser,options:{validate:{...r.updateUserValidator.validate,failAction:r.updateUserValidator.failAction},payload:{maxBytes:i.maxBytes}}},{method:"PATCH",path:`${s.baseUrl}/users/refresh`,handler:o.usersHandler.refreshUser,options:{validate:{payload:r.refreshUserValidator.validate.payload,failAction:r.refreshUserValidator.failAction}}},{method:"PATCH",path:`${s.baseUrl}/users/location`,handler:o.usersHandler.updateLocation,options:{validate:{payload:r.updateLocationValidator.validate.payload,failAction:r.updateLocationValidator.failAction}}},{method:"DELETE",path:l,handler:o.usersHandler.deleteLocation},{method:"PATCH",path:`${s.baseUrl}/users/display`,handler:o.usersHandler.changeDisplay,options:{validate:{payload:r.changeUserDisplayValidator.validator.payload,failAction:r.changeUserDisplayValidator.failAction}}},{method:"PATCH",path:`${s.baseUrl}/users/videoEditDescription`,handler:o.usersHandler.changeVideoEditDescription,options:{validate:{payload:r.changeVideoEditDescriptionValidator.validator.payload,failAction:r.changeVideoEditDescriptionValidator.failAction}}},{method:"PATCH",path:`${s.baseUrl}/users/talkRoomMessageReceipt`,handler:o.usersHandler.changeTalkRoomMessageReceipt,options:{validate:{payload:r.changeTalkRoomMessageReceiptValidator.validator.payload,failAction:r.changeTalkRoomMessageReceiptValidator.failAction}}},{method:"PATCH",path:n,handler:o.usersHandler.changeShowReceiveMessage,options:{validate:{payload:r.changeShowReceiveMessageValidator.validator.payload,failAction:r.changeShowReceiveMessageValidator.failAction}}}])}},3845:function(e,a,t){var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(a,"__esModule",{value:!0}),a.changeShowReceiveMessageValidator=a.changeTalkRoomMessageReceiptValidator=a.changeVideoEditDescriptionValidator=a.changeUserDisplayValidator=a.updateLocationValidator=a.refreshUserValidator=a.updateUserValidator=void 0;const o=r(t(4320)),s=t(6760),i={payload:o.default.object({name:o.default.string().required(),avatar:o.default.string().optional(),avatarExt:o.default.string().allow(null).optional(),introduce:o.default.string().allow("").required(),statusMessage:o.default.string().allow("").required(),deleteAvatar:o.default.boolean().required(),backGroundItem:o.default.string().optional(),backGroundItemType:o.default.string().valid("image","video").optional(),deleteBackGroundItem:o.default.boolean().required(),backGroundItemExt:o.default.string().allow(null).optional(),instagram:o.default.string().allow(null),twitter:o.default.string().allow(null),youtube:o.default.string().allow(null),tiktok:o.default.string().allow(null)})};a.updateUserValidator={validate:i,failAction:()=>s.throwInvalidError("無効なデータが含まれています")};const n={payload:o.default.object({userId:o.default.string().required()})};a.refreshUserValidator={validate:n,failAction:()=>s.throwInvalidError()};const l={payload:o.default.object({lat:o.default.number().required(),lng:o.default.number().required()})};a.updateLocationValidator={validate:l,failAction:()=>s.throwInvalidError()};const d={payload:o.default.object({display:o.default.boolean().required()})};a.changeUserDisplayValidator={validator:d,failAction:()=>s.throwInvalidError()};const u={payload:o.default.object({videoEditDescription:o.default.boolean().required()})};a.changeVideoEditDescriptionValidator={validator:u,failAction:()=>s.throwInvalidError()};const c={payload:o.default.object({receipt:o.default.boolean().required()})};a.changeTalkRoomMessageReceiptValidator={validator:c,failAction:()=>s.throwInvalidError()};const p={payload:o.default.object({showReceiveMessage:o.default.boolean().required()})};a.changeShowReceiveMessageValidator={validator:p,failAction:()=>s.throwInvalidError()}},161:(e,a,t)=>{Object.defineProperty(a,"__esModule",{value:!0}),a.viewedFlashesRoute=void 0;const r=t(8704),o=t(461),s=t(6977);a.viewedFlashesRoute=async e=>{e.route([{method:"POST",path:`${r.baseUrl}/viewedFlashes`,handler:s.viewedFlashHandler.createViewedFlash,options:{validate:{payload:o.createViewedFlashValidator.validate.payload,failAction:o.createViewedFlashValidator.failAction}}}])}},461:function(e,a,t){var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(a,"__esModule",{value:!0}),a.createViewedFlashValidator=void 0;const o=r(t(4320)),s=t(6760),i={payload:o.default.object({flashId:o.default.number().required()})};a.createViewedFlashValidator={validate:i,failAction:()=>s.throwInvalidError()}},4158:(e,a)=>{Object.defineProperty(a,"__esModule",{value:!0}),a.serializeFlash=void 0,a.serializeFlash=({flash:e})=>{const{id:a,source:t,sourceType:r,viewed:o,stamps:s}=e;return{id:a,source:t,sourceType:r,timestamp:new Date(e.createdAt).toString(),viewsNumber:o.length}}},5886:(e,a,t)=>{Object.defineProperty(a,"__esModule",{value:!0}),a.serializePost=void 0;const r=t(3147);a.serializePost=({post:e})=>{const a=r.formatDate({date:e.createdAt});return{id:e.id,url:e.url,sourceType:e.sourceType,text:e.text,userId:e.userId,date:a}}},3966:(e,a)=>{Object.defineProperty(a,"__esModule",{value:!0}),a.serializeTalkRoom=void 0,a.serializeTalkRoom=({talkRoom:e,talkRoomMessages:a,readTalkRoomMessages:t,userId:r})=>{const o=e.senderId===r?e.recipientId:e.senderId,s=a.map((e=>e.id)).reverse(),i=a.filter((e=>e.userId!==r&&e.receipt)),n=t.filter((e=>e.userId===r)),l=i.length-n.length,d=a.reverse().find((e=>e.userId===r||e.receipt));return{id:e.id,partner:o,messages:s,unreadNumber:l,latestMessage:d?d.text:null,timestamp:e.updatedAt.toString()}}},8726:(e,a)=>{Object.defineProperty(a,"__esModule",{value:!0}),a.serializeTalkRoomMessage=void 0,a.serializeTalkRoomMessage=({talkRoomMessage:e})=>{const{id:a,userId:t,roomId:r,text:o}=e;return{id:a,userId:t,roomId:r,text:o,timestamp:e.createdAt.toString()}}},8750:(e,a,t)=>{Object.defineProperty(a,"__esModule",{value:!0}),a.serializeUser=void 0;const r=t(2306);a.serializeUser=({user:e})=>{const{lineId:a,createdAt:t,updatedAt:o,accessToken:s,inPrivateZone:i,login:n,...l}=e;let d=null,u=null;if(l.lat&&l.lng){const{lat:e,lng:a}=r.handleUserLocationCrypt(l.lat,l.lng,"decrypt");d=e,u=a}return{...l,lat:d||null,lng:u||null}}},6873:function(e,a,t){var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(a,"__esModule",{value:!0}),a.startServer=a.initializeServer=a.talkRoomMessageNameSpace=a.io=void 0;const o=r(t(5787)),s=r(t(5500)),i=r(t(2395)),n=r(t(4054)),l=t(3157),d=t(6760),u=t(3582),c=t(2182),p=t(9711),h=t(8263),f=t(5601),m=t(4452),v=t(1550),g=t(3643),y=t(328),w=t(262),_=t(7134),b=t(7335),M=t(6509),k=t(8331),R=t(7760),P=t(9078),T=t(1916),I=o.default.server({port:process.env.PORT||4001});a.io=new i.default.Server(I.listener),a.talkRoomMessageNameSpace=a.io.of("/talkRoomMessages"),u.setupSocketIo(),n.default.initializeApp({credential:n.default.credential.applicationDefault()}),a.initializeServer=async()=>(await I.register(s.default),I.auth.strategy("simple","bearer-access-token",{validate:l.checkBeareAccessToken,unauthorized:()=>{console.log("認可失敗"),d.throwLoginError()}}),I.auth.default("simple"),await I.register({plugin:t(5378),options:{prettyPrint:!0,redact:["req.headers.authorization"],logPayload:!1,logQueryParams:!0}}),await I.register([p.prismaPlugin,h.noncePlugin,c.rootPlugin,f.sesisonsPlugin,m.usersPlugin,v.postsPlugin,g.flashesPlugin,y.viewedFlashesPlugin,w.nearbyUsersPlugin,_.talkRoomsPlugin,b.talkRoomMessagesPlugin,M.readTalkRoomMessagesPlugin,k.deviceTokenPlugin,R.flashStampsPlugin,P.privateZonePlugin,T.privateTimePlugin]),await I.initialize(),I),a.startServer=async e=>(await e.start(),console.log("サーバー起動: "+e.info.uri),e)},3582:(e,a,t)=>{Object.defineProperty(a,"__esModule",{value:!0}),a.setupSocketIo=void 0;const r=t(6873);a.setupSocketIo=()=>{r.talkRoomMessageNameSpace.on("connection",(async e=>{const a=e.handshake.query;a&&await e.join(a.id)}))}},3147:(e,a,t)=>{Object.defineProperty(a,"__esModule",{value:!0}),a.confirmInTime=a.formatDate=a.filterByDayDiff=void 0;const r=t(6459);a.filterByDayDiff=(e,a)=>((new Date).getTime()-new Date(e).getTime())/r.dayMs<a,a.formatDate=({date:e})=>`${new Date(e).getFullYear()}/${new Date(e).getMonth()+1}/${new Date(e).getDate()}`,a.confirmInTime=({startHours:e,startMinutes:a,endHours:t,endMinutes:r,h:o,m:s})=>e<t?e===o?a<=s:t===o?s<=r:e<o&&o<t:e===t?a===r?e===o&&a===s:e===o&&a<=s&&s<=r:e===o?a<=s:t===o?s<=r:o>e||o<t},7796:e=>{e.exports=require("@hapi/boom")},5787:e=>{e.exports=require("@hapi/hapi")},212:e=>{e.exports=require("@prisma/client")},8366:e=>{e.exports=require("@turf/distance")},4801:e=>{e.exports=require("@turf/helpers")},3480:e=>{e.exports=require("aws-sdk")},2376:e=>{e.exports=require("axios")},419:e=>{e.exports=require("crypto-js")},6902:e=>{e.exports=require("crypto-js/sha256")},4054:e=>{e.exports=require("firebase-admin")},5114:e=>{e.exports=require("fluent-ffmpeg")},5747:e=>{e.exports=require("fs")},5500:e=>{e.exports=require("hapi-auth-bearer-token")},5378:e=>{e.exports=require("hapi-pino")},4320:e=>{e.exports=require("joi")},742:e=>{e.exports=require("sharp")},2395:e=>{e.exports=require("socket.io")},1669:e=>{e.exports=require("util")},1231:e=>{e.exports=require("uuid")}},a={};function t(r){var o=a[r];if(void 0!==o)return o.exports;var s=a[r]={exports:{}};return e[r].call(s.exports,s,s.exports,t),s.exports}(()=>{const e=t(6873);(async()=>{const a=await e.initializeServer();await e.startServer(a)})()})()})();